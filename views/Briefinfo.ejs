<% layout("/layout/boilerplate") %>

<% if(success && success.length > 0) { %>
  <div class="alert alert-success">
    <%= success[0] %>
  </div>
<% } %>
<% if(error && error.length > 0) { %>
  <div class="alert alert-danger">
    <%= error[0] %>
  </div>
<% } %>

<body>
  <div class="container my-5">
    <div class="card shadow-lg mx-auto border-0 rounded-4" style="max-width: 700px;">

      <!-- Image -->
      <img src="<%= totaldata.image || 'default-url' %>" 
           class="card-img-top rounded-top-4" 
           alt="<%= totaldata.title %>"
           style="height: 350px; object-fit: cover;">

      <!-- Owner Info -->
      <div class="card-body p-4">
        <% if(totaldata.owner) { %>
          <h2 class="card-title mb-3 text-primary fw-bold">Owner: <%= totaldata.owner.username %></h2>
          <p class="text-muted mb-3">
            <i class="fa-solid fa-envelope text-danger"></i>
            <%= totaldata.owner.email %>
          </p>
        <% } else { %>
          <h2 class="card-title mb-3 text-secondary">Owner: Not Assigned</h2>
        <% } %>
      </div>

      <!-- Listing Info -->
      <div class="card-body p-4">
        <h2 class="card-title mb-3 text-primary fw-bold"><%= totaldata.title %></h2>
        <p class="text-muted mb-3">
          <i class="fa-solid fa-location-dot text-danger"></i> 
          <%= totaldata.location %>, <%= totaldata.country %>
        </p>
        <p class="card-text mb-3"><%= totaldata.description %></p>
        <h5 class="text-success fw-semibold">$<%= totaldata.price %> / night</h5>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center mt-4">
          <a href="/listings" class="btn btn-outline-secondary">üè† Home</a>

         
            <div>
              <a href="/listings/edit/<%= totaldata._id %>" class="btn btn-primary me-2">‚úèÔ∏è Edit</a>
              <form action="/listings/delete/<%= totaldata._id %>?_method=delete" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger">üóëÔ∏è Delete</button>
              </form>
            </div>
         
        </div>
      </div>

      <!-- Review Section -->
      <div class="card-body p-4">
        <h4 class="mb-3">üí¨ Leave a Review</h4>

        <% if(currentUser) { %>
          <form action="/listings/<%= totaldata._id %>/reviews" method="post" novalidate class="needs-validation">
            <div class="mb-3">
              <textarea name="review[comment]" class="form-control" rows="3" placeholder="Enter your comment"></textarea>
            </div>
            <div class="mb-3">
              <input type="number" name="review[rating]" class="form-control w-50" placeholder="Enter Rating 1-5" min="1" max="5">
            </div>
            <button type="submit" class="btn btn-success">Submit Review</button>
          </form>
        <% } else { %>
          <p class="text-muted fst-italic">Please <a href="/login">login</a> to leave a review.</p>
        <% } %>

        <hr>
        <h4>All Reviews</h4>
        <% if(totaldata.review.length > 0) { %>
          <% for(let rev of totaldata.review) { %>
            <div class="border rounded-3 p-3 mb-3 bg-light">
              <h3 class="mb-1"><%= rev.author.username %></h3>
              <p class="mb-1">Comment: <%= rev.comment %></p>
              <h6 class="mb-2 text-warning">‚≠ê <%= rev.rating %></h6>

              <% if(currentUser && rev.author && currentUser._id.toString() === rev.author._id.toString()) { %>
                <form action="/listings/<%= totaldata._id %>/reviews/delete/<%= rev._id %>?_method=delete" method="post">
                  <button type="submit" class="btn btn-sm btn-dark">Delete Review</button>
                </form>
              <% } %>
            </div>
          <% } %>
        <% } else { %>
          <p class="text-muted">No reviews yet</p>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Custom Styling -->
  <style>
    body {
      background: linear-gradient(120deg, #f8f9fa, #e9ecef);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card-title {
      font-size: 1.6rem;
    }
    textarea, input {
      border-radius: 10px;
    }
    .btn {
      min-width: 100px;
      border-radius: 8px;
    }
  </style>
</body>
</html>
